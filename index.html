<!DOCTYPE html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.6">
    <title>Lunch</title>
	<!-- <link href="images/favicon.ico" rel="icon" type="image/x-icon" /> -->
	<link rel="apple-touch-icon" href="images/touch-icon-iphone.png">
	<link rel="apple-touch-icon" sizes="76x76" href="images/touch-icon-ipad.png">
	<link rel="apple-touch-icon" sizes="120x120" href="images/touch-icon-iphone-retina.png">
	<link rel="apple-touch-icon" sizes="152x152" href="images/touch-icon-ipad-retina.png">
	<style>
		body {
			margin: 0px;
			padding: 0px;
			font-size: 18px;
			background-color: #923a08;
			background-image: url(images/bg.png);
			color: #231b00;
			text-shadow: 1px 1px 1px #cc731c;
		}
		ul {
			list-style: none;
			margin: 0px;
			margin-bottom: 10px;
			padding: 0px;
		}
		ul li {
			margin: 1px;
			padding: 0px;
		}
		label {
			display: block;
		}
		input {
			font-size: 18px;
		}
		input[type=text], input[type=number] {
			width: 120px;
			border: solid 1px #401400;
			background-color: #f2e7c4;
			box-shadow: inset 1px 1px 2px 0 #707070;
			transition: box-shadow 0.3s;
			padding: 7px;
			margin-bottom: 3px;
		}
		input[type="text"]:focus,
		input[type="text"].focus {
			box-shadow: inset 1px 1px 2px 0 #c9c9c9;
		}
		input[type=button] {
			background: #e3a32d;
			background-image: -webkit-linear-gradient(top, #e3a32d, #945105);
			background-image: -moz-linear-gradient(top, #e3a32d, #945105);
			background-image: -ms-linear-gradient(top, #e3a32d, #945105);
			background-image: -o-linear-gradient(top, #e3a32d, #945105);
			background-image: linear-gradient(to bottom, #e3a32d, #945105);
			-webkit-border-radius: 7;
			-moz-border-radius: 7;
			border-radius: 7px;
			text-shadow: 1px 1px 1px #faa300;
			font-family: Arial;
			color: #5c1d00;
			padding: 7px 13px;
			border: solid #401400 1px;
			text-decoration: none;
			margin-right: 3px;
		}

		input[type=button]:hover {
			background: #ffc663;
			background-image: -webkit-linear-gradient(top, #ffc663, #b86c1b);
			background-image: -moz-linear-gradient(top, #ffc663, #b86c1b);
			background-image: -ms-linear-gradient(top, #ffc663, #b86c1b);
			background-image: -o-linear-gradient(top, #ffc663, #b86c1b);
			background-image: linear-gradient(to bottom, #ffc663, #b86c1b);
			text-decoration: none;
		}
		h1 {
			_color: #231b00;
			font-size: 34px;
			line-height: 1;
			_text-shadow: 1px 1px 1px #cc731c;
			margin-top: 0px;
			margin-bottom: 10px;
		}
		.center {
		    margin-left: auto;
		    margin-right: auto;
		    width: 190px;
		}
		.step {
			margin-bottom: 10px;
		}
		#step_names, #step_expenses, #step_tax, #step_tip, #step_result {
			display: none;
		}
		li.line {
			border-bottom: 1px dotted gray;
		}
		.b {
			font-weight: bold;
		}
		.r {
			background-color: #f7f7f7;
		}
		.step {
			padding: 20px 15px;
			margin: 10px;
			background: #ff0030;
			color: #fff;
			font-weight: bold;
			line-height: 1.3em;
			border: 2px dashed #fff;
			border-radius: 10px;
			box-shadow: 0 0 0 4px #ff0030, 2px 1px 6px 4px rgba(10, 10, 0, 0.5);
			text-shadow: -1px -1px #aa3030;
			font-weight: normal;
		}
		#count {
			width: 55px;
		}
		#buttons {
			height: 33px;
		}
		#start_over {
			font-size: 24px;
			line-height: 24px;
			padding-top: 6px;
			padding-bottom: 6px;
		}
		#my_friends {overflow: hidden; margin: auto; padding: 0; margin: 0;}
		#my_friends li {float: left; list-style: none; padding: 10px;}
		#my_friends li h3 {color:white; font-size: 10px;}
		#my_friends li img {width: 80px; height: 80px;}

	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.6.1.min.js"><\/script>')</script>
	<script>
	var L = {
		config: {
			count: 0,
			tax_rate: 8.875,
			tip_rate: 15
		},
		init : function() {
	        $("#step_count #next").click(function (e) {
				L._fn.swichStep();
				L._fn.step_count.clickNext();
	        });

	        $("#step_names #next").click(function (e) {
				L._fn.swichStep();
				L._fn.step_names.clickNext();
	        });
	        $("#step_names #back").click(function (e) {
				L._fn.swichStep();
				L._fn.step_names.clickBack();
	        });

	        $("#step_expenses #next").click(function (e) {
				L._fn.swichStep();
				L._fn.step_expenses.clickNext();
	        });
	        $("#step_expenses #back").click(function (e) {
				L._fn.swichStep();
				L._fn.step_expenses.clickBack();
	        });

	        $("#step_tax #next").click(function (e) {
				L._fn.swichStep();
				L._fn.step_tax.clickNext();
	        });
	        $("#step_tax #back").click(function (e) {
				L._fn.swichStep();
				L._fn.step_tax.clickBack();
	        });
		        $("#step_tax #tax_rate").blur(function (e) {
					L._fn.step_tax.changeTaxRate();
		        });
		        $("#step_tax #tax").blur(function (e) {
					L._fn.step_tax.changeTax();
		        });
	        $("#step_tip #next").click(function (e) {
				L._fn.swichStep();
				L._fn.step_tip.clickNext();
	        });
	        $("#step_tip #back").click(function (e) {
				L._fn.swichStep();
				L._fn.step_tip.clickBack();
	        });
		        $("#step_tip #tip_rate").change(function (e) {
					L._fn.step_tip.changeTipRate();
		        });
		        $("#step_tip #tip").blur(function (e) {
					L._fn.step_tip.changeTip();
		        });
		        $("#step_tip #tip_total").blur(function (e) {
					L._fn.step_tip.changeTipTotal();
		        });
	        $("#step_result #start_over").click(function (e) {
				L._fn.swichStep();
	            L._fn.step_result.clickNext();
	        });
	        $("#step_result #back").click(function (e) {
				L._fn.swichStep();
				L._fn.step_result.clickBack();
	        });

		},
		_fn : {
			swichStep: function() {
				window.scrollTo(0,0);
			},
			util: {
				getRoundedNumber: function(num, point) {
					var times = point * 10;
					return Math.round(num * times) / times;
				}
			},
			step_count: {
				clickNext : function() {
					L.config.count = $("#step_count #count").val();
		            L._fn.step_names.init();
		            L._fn.step_count.showNext();
				},
				showNext : function() {
		            $('#step_count #input').prop('readonly', true);
		            $("#step_count").hide();
		            $("#step_names").show();
				}
			},
			step_names: {
				init: function () {
					L._fn.step_names.addNameInputs();
				},
				addNameInputs : function() {
					$("#step_names #names ul").remove();
					$("#step_names #names").append("<ul></ul>");
					for (var i = 1; i <= L.config.count; i++) {
						switch (i) {
							case 1: name = 'Marcin'; break;
							case 2: name = 'Luka'; break;
							case 3: name = 'Pawel'; break;
							case 4: name = 'Sung'; break;
							default: name = ''; break;
						}
						$('#step_names #names ul').append('<li><input type="text" id="name'+i+'" value="'+name+'" /></li>');
					}
				},
				clickNext : function() {
		            L._fn.step_expenses.init();
		            L._fn.step_names.showNext();
				},
				showNext : function() {
		            $("#step_names").hide();
		            $("#step_expenses").show();
				},
				clickBack : function() {
		            $("#step_names").hide();
		            $("#step_count").show();
				}
			},
			step_expenses: {
				init: function () {
					L._fn.step_expenses.addExpenseInputs();
				},
				addExpenseInputs : function() {
					$("#step_expenses #expenses ul").remove();
					$("#step_expenses #expenses").append("<ul></ul>");
					var li;
					for (var i = 1; i <= L.config.count; i++) {
						li = '<li><label>'+$('#step_names #name'+i).val()+'</label></li>';
						li += '<li><input type="number" id="expense'+i+'_1" value="" placeholder="Price 1"/></li>';
						li += '<li><input type="number" id="expense'+i+'_2" value="" placeholder="Price 2" /></li>';
						li += '<li><input type="number" id="expense'+i+'_3" value="" placeholder="Price 3" /></li>';
						$('#step_expenses ul').append(li);
					}
				},
				clickNext : function() {
		            L._fn.step_tax.init();
		            L._fn.step_expenses.showNext();
				},
				showNext : function() {
		            $("#step_expenses").hide();
		            $("#step_tax").show();
				},
				clickBack : function() {
		            $("#step_expenses").hide();
		            $("#step_names").show();
				}
			},
			step_tax: {
				init: function () {
					L._fn.step_tax.setTaxRate();
					L._fn.step_tax.setExpenseTotal();
					L._fn.step_tax.setTax();
					L._fn.step_tax.setTaxTotal();
					return true;
				},
				setTaxRate : function() {
					$("#step_tax #tax_rate").val(L.config.tax_rate);
					return true;
				},
				getTaxRate : function() {
					L.config.tax_rate = $("#step_tax #tax_rate").val();
					return true;
				},
				setExpenseTotal : function() {
					var total = 0;
					var expense1, expense2, expense3;
					for (var i=1; i<=L.config.count; i++) {
						expense1 = $("#step_expenses #expense"+i+"_1").val();
						if (expense1 !== undefined && expense1 !== '') {
							total += parseFloat(expense1);
						}
						expense2= $("#step_expenses #expense"+i+"_2").val();
						if (expense2 !== undefined && expense2 !== '') {
							total += parseFloat(expense2);
						}
						expense3 = $("#step_expenses #expense"+i+"_3").val();
						if (expense3 !== undefined && expense3 !== '') {
							total += parseFloat(expense3);
						}
					}
					$("#step_tax #expense_total").val(L._fn.util.getRoundedNumber(total, 2));
					return true;
					},
				getTax : function(money) {
					var tax = money * L.config.tax_rate / 100;
					return tax;
				},
				setTax : function () {
					var expense_total = parseFloat($("#step_tax #expense_total").val());
					var tax = expense_total * L.config.tax_rate / 100;
					$("#step_tax #tax").val(tax);
					return true;
				},
				setTaxTotal : function () {
					var expense_total = parseFloat($("#step_tax #expense_total").val());
					var tax = parseFloat($("#step_tax #tax").val());
					var tax_total = expense_total + tax;
					$("#step_tax #tax_total").val(tax_total);
					return true;
				},
				changeTaxRate: function() {
					L._fn.step_tax.getTaxRate();
					L._fn.step_tax.setTax();
					L._fn.step_tax.setTaxTotal();
					L._fn.step_expenses.showNext();
					return true;
				},
				changeTax: function() {
					L._fn.step_tax.setTaxRateByTax();
					L._fn.step_tax.setTax();
					L._fn.step_tax.setTaxTotal();
					L._fn.step_expenses.showNext();
					return true;
				},
				setTaxRateByTax: function() {
					var expense_total = parseFloat($("#step_tax #expense_total").val());
					var tax = parseFloat($("#step_tax #tax").val());
					var tax_rate = tax / expense_total;
					tax_rate  = tax_rate * 100;
					L.config.tax_rate = tax_rate;
					L._fn.step_tax.setTaxRate();
					return true;
				},
				clickNext : function() {
		            L._fn.step_tip.init();
		            L._fn.step_tax.showNext();
				},
				showNext : function() {
		            $("#step_tax").hide();
		            $("#step_tip").show();
				},
				clickBack : function() {
		            $("#step_tax").hide();
		            $("#step_expenses").show();
				}
			},
			step_tip: {
				init: function () {
					L._fn.step_tip.setTipRate();
					L._fn.step_tip.setTipRateText();
					L._fn.step_tip.setTip();
					L._fn.step_tip.setTipTotal();
					return true;
				},
				setTipRate : function() {
					$("#step_tip #tip_rate").val(L._fn.util.getRoundedNumber(L.config.tip_rate, 2));
					return true;
				},
				setTipRateText : function() {
					$("#step_tip #tip_rate_text").text(L._fn.util.getRoundedNumber(L.config.tip_rate, 1));
					return true;
				},
				getTipRate : function() {
					L.config.tip_rate = L._fn.util.getRoundedNumber($("#step_tip #tip_rate").val(), 2);
					return true;
				},
				setTip : function () {
					var tax_total = $("#step_tax #tax_total").val();
					var tip = tax_total * L.config.tip_rate / 100;
					$("#step_tip #tip").val(L._fn.util.getRoundedNumber(tip, 2));
					return true;
				},
				setTipTotal : function () {
					var tax_total = parseFloat($("#step_tax #tax_total").val());
					var tip = parseFloat($("#step_tip #tip").val());
					var tip_total = tax_total + tip;
					$("#step_tip #tip_total").val(L._fn.util.getRoundedNumber(tip_total, 2));
					return true;
				},
				changeTipRate: function() {
					L._fn.step_tip.getTipRate();
					L._fn.step_tip.setTipRateText();
					L._fn.step_tip.setTip();
					L._fn.step_tip.setTipTotal();
					L._fn.step_tax.showNext();
					return true;
				},
				changeTip: function() {
					L._fn.step_tip.setTipRateByTip();
					L._fn.step_tip.setTipRateText();
					L._fn.step_tip.setTip();
					L._fn.step_tip.setTipTotal();
					L._fn.step_tax.showNext();
					return true;
				},
				changeTipTotal: function() {
					var tax_total = parseFloat($("#step_tax #tax_total").val());
					var tip_total = parseFloat($("#step_tip #tip_total").val());
					$("#step_tip #tip").val(L._fn.util.getRoundedNumber(tip_total - tax_total, 2));
					L._fn.step_tip.changeTip();
					return true;
				},
				setTipRateByTip: function() {
					var tax_total = parseFloat($("#step_tax #tax_total").val());
					var tip = parseFloat($("#step_tip #tip").val());
					L.config.tip_rate = tip / tax_total * 100;
					L._fn.step_tip.setTipRate();
					return true;
				},
				clickNext : function() {
		            L._fn.step_result.init();
		            L._fn.step_tip.showNext();
				},
				showNext : function() {
		            $("#step_tip").hide();
		            $("#step_result").show();
		        },
				clickBack : function() {
		            $("#step_tip").hide();
		            $("#step_tax").show();
				}
			},
			step_result : {
				init : function() {
					L._fn.step_result.addResultInputs();
					L._fn.step_result.divide();
				},
				addResultInputs: function() {
					$("#step_result #result ul").remove();
					$("#step_result #result").append("<ul></ul>");
					var name = '';
					for (var i = 1; i <= L.config.count; i++) {
						name = $("#step_names #name"+i).val();
						$('#step_result #result ul').append('<li><label>'+name+'</label> <input type="number" id="result'+i+'" value="" /></li>');
					}
				},
				divide : function() {
					// extra tax
					var expense_total = parseFloat($("#step_tax #expense_total").val());
					var org_tax = L._fn.step_tax.getTax(expense_total);
					var cur_tax = parseFloat($("#step_tax #tax").val());
					var dif_tax = cur_tax - org_tax;
					var added_tax_each = dif_tax / L.config.count;

					// tip
					var cur_tip = $("#step_tip #tip").val();
					var tip_total = $("#step_tip #tip_total").val();
					var tip_each = cur_tip / L.config.count;

					// each with tax
					var total_each = 0;
					var expense1, expense2, expense3;
					var tax_each;
					var total_final = 0;
					for (var i=1; i<=L.config.count; i++) {
						total_each = 0;
						expense1 = $("#step_expenses #expense"+i+"_1").val();
						if (expense1 !== undefined && expense1 !== '') {
							total_each += parseFloat(expense1);
						}
						expense2= $("#step_expenses #expense"+i+"_2").val();
						if (expense2 !== undefined && expense2 !== '') {
							total_each += parseFloat(expense2);
						}
						expense3 = $("#step_expenses #expense"+i+"_3").val();
						if (expense3 !== undefined && expense3 !== '') {
							total_each += parseFloat(expense3);
						}
						tax_each = L._fn.step_tax.getTax(total_each);
						total_each = total_each + tax_each + added_tax_each + tip_each;
						total_each = L._fn.util.getRoundedNumber(total_each, 2);
						$("#step_result #result"+i).val(total_each);
						total_final += total_each;
					}
					var diff = tip_total - total_final;
					if (diff >= 1) {
						if (diff < L.config.count) {
							var ran = 0;
							for (var i=0; i<=L.config.count; i++) {
								ran = Math.floor((Math.random() * L.config.count) + 1);
								$("#step_result #result"+ran).val(parseFloat($("#step_result #result"+ran).val()) + 1);
							}
						}else {
							alert('error');
						}
					}
				},
				clickNext : function() {
		            location.reload();
				},
				clickBack : function() {
		            $("#step_result").hide();
		            $("#step_tip").show();
				}
			}
		}
	};

	var V = {
		api : {
			proxy 	: "https://agile-ridge-2099.herokuapp.com/ba-simple-proxy.php?url=",
			me 		: "https://api.venmo.com/v1/me?access_token=",
			friends	: "https://api.venmo.com/v1/users/"
		},
	    token 		: "",
		user 		: {},
		friends 	: [],

		_fn : {
			getMe : function () {
				$.getJSON(V.api.proxy + V.api.me + V.token + "&callback=?", function(result) {
					console.log("getting user details...");
					if (result.contents.data) {
						V.user = result.contents.data.user;
						console.log(V.user);
						V._fn.getFriends();
					} else {
						console.log("NO USER! (probably token expired)");
					}
				});
			},
			getFriends : function () {
				$.getJSON(V.api.proxy + V.api.friends + V.user.id + "/friends?access_token=" + V.token + "&callback=?", function(result) {
					console.log("getting friends...");
					V.friends = result.contents.data;
					console.log(V.friends);
					V._fn.showFriends();
				});
			},

			showFriends : function () {
				var friends_html = [];
				$.each(V.friends, function (i, friend) {

					li_friend = [ "<li data-id='" + friend.id + "'>",
								  "<h3>" + friend.display_name + "</h3>",
								  "<img src='" + friend.profile_picture_url + "' title ='" + friend.display_name + "' />",
								  "</li>"
								].join("");
					friends_html.push(li_friend);

				});
				$("#my_friends").append(friends_html.join(""));
			},

			getParameterByName : function (name) {
			    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
			        results = regex.exec(location.search);
			    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}
		},

		init : function () {
			console.warn("venmo initalized!");
			if (V._fn.getParameterByName('access_token')) {
				V.token = V._fn.getParameterByName('access_token')
				V._fn.getMe();
			}
		}
	};

	$(document).ready(function () {
		L.init();
		V.init();
	});
</script>
</head>
<body>
<div class="bg">
<div class="center">
	<div id="step_count" class="step">
		<h1>How Many People?</h1>
		<input type="number" id="count" value="4" />
		<input type="button" value="Go" id="next" />
		<a class="venmo" href="https://api.venmo.com/v1/oauth/authorize?client_id=2437&scope=access_friends%20access_profile&response_type=token">Venmo</a>
	</div>

	<div id="step_names" class="step">
		<h1>Please Enter Names</h1>
		<div id="names"></div>
		<div id="buttons">
			<input type="button" value="Back" id="back" />
			<input type="button" value="Go" id="next" />
		</div>
	</div>

	<div id="step_expenses" class="step">
		<h1>Expenses</h1>
		<div id="expenses"></div>
		<div id="buttons">
			<input type="button" value="Back" id="back" />
			<input type="button" value="Go" id="next" />
		</div>
	</div>
	<div id="step_tax" class="step">
		<h1>Tax</h1>
		<ul>
			<li><label class="b">Total</label> <input type="number" id="expense_total" value="" class="r" readonly /></li>
			<li><label>Tax Rate(<span id="tax_rate_text"></span>%)</label> <input type="number" id="tax_rate" value="" /></li>
			<li><label>Tax</label> <input type="number" id="tax" value="" /></li>
			<li><label class="b">Tax Total</label> <input type="number" id="tax_total" value="" class="r" readonly /></li>
		</ul>
		<div id="buttons">
			<input type="button" value="Back" id="back" />
			<input type="button" value="Go" id="next" />
		</div>
	</div>
	<div id="step_tip" class="step">
		<h1>Tip</h1>
		<ul>
			<li><label>Tip Rate(<span id="tip_rate_text"></span>%)</label> <input type="range" id="tip_rate" value="" min="0" max="30"/></li>
			<li><label>Tip </label> <input type="number" id="tip" value="" /></li>
			<li><label class="b">Tip Total</label> <input type="number" id="tip_total" value="" /></li>
		</ul>
		<div id="buttons">
			<input type="button" value="Back" id="back" />
			<input type="button" value="Go" id="next" />
		</div>
	</div>
	<div id="step_result" class="step">
		<h1>Result</h1>
		<div id="result"></div>
		<div id="buttons">
			<input type="button" value="Back" id="back" />
			<input type="button" value="↺" id="start_over" />
		</div>
	</div>
</div>
</div>
<div id="my_friends"></div></div>
</body>
</html>